# 📋 下一步行动清单

## 🎯 目标
完成项目架构重构的剩余部分，使新架构可以运行。

## ✅ 进度概览

```
总进度: ████████░░ 75%

已完成 (75%):
✅ config/       (100%) - 配置模块
✅ utils/        (100%) - 工具模块  
✅ core/         (100%) - 核心引擎
✅ ui/region_selector.py (100%) - 区域选择器

待完成 (25%):
⏳ ui/capture_window.py - 监视窗口
⏳ ui/main_window.py - 主窗口
⏳ ui/__init__.py - UI 模块导出
⏳ src/main.py - 程序入口
```

## 📝 详细步骤

### 步骤 1: 创建 UI 模块导出文件 (5分钟)

**文件**: `src/ui/__init__.py`

**内容**:
```python
"""UI 模块"""
from .main_window import MainWindow
from .capture_window import CaptureWindow
from .region_selector import RegionSelector

__all__ = ['MainWindow', 'CaptureWindow', 'RegionSelector']
```

**检查**: ✅ 文件创建成功

---

### 步骤 2: 迁移监视窗口 (30分钟)

**文件**: `src/ui/capture_window.py`

**任务**:
1. 从 `window_capture_pyqt6.py` 复制 `CaptureWindow` 类（行 345-430）
2. 修改导入语句
3. 移除 `update_capture()` 中的捕获逻辑
4. 添加信号连接

**关键代码片段**:
```python
from PyQt6.QtWidgets import QDialog, ...
from PyQt6.QtCore import Qt, QPoint
from ..core import CaptureEngine
from ..utils import logger

class CaptureWindow(QDialog):
    def __init__(self, engine: CaptureEngine, window_title: str):
        super().__init__()
        self.engine = engine
        self.window_title = window_title
        
        # 连接信号
        self.engine.frame_captured.connect(self.on_frame)
        self.engine.fps_updated.connect(self.on_fps_updated)
        self.engine.method_changed.connect(self.on_method_changed)
        self.engine.capture_failed.connect(self.on_capture_failed)
        
        self._init_ui()
        self.engine.start()
    
    def on_frame(self, image):
        """处理新帧"""
        self.scene.clear()
        self.scene.addPixmap(QPixmap.fromImage(image))
        ...
```

**检查**: ✅ 文件创建成功，无语法错误

---

### 步骤 3: 迁移主窗口 (30分钟)

**文件**: `src/ui/main_window.py`

**任务**:
1. 从 `window_capture_pyqt6.py` 复制 `MainWindow` 类（行 695-965）
2. 修改导入语句
3. 在 `start_capture()` 中使用 `CaptureEngine`

**关键修改**:
```python
from ..utils import WindowManager, ScreenCapture, logger
from ..core import CaptureEngine
from ..config import settings
from .region_selector import RegionSelector
from .capture_window import CaptureWindow

class MainWindow(QMainWindow):
    ...
    
    def start_capture(self):
        hwnd = ...
        region = ...
        fps = ...
        
        # 创建引擎
        engine = CaptureEngine(hwnd, region, fps)
        
        # 创建窗口
        window = CaptureWindow(engine, window_title)
        window.show()
        
        # 保存引用
        self.capture_windows.append((engine, window))
```

**检查**: ✅ 文件创建成功，无语法错误

---

### 步骤 4: 创建程序入口 (10分钟)

**文件**: `src/main.py`

**内容**:
```python
"""
实时窗口监视器 - 程序入口
"""
import sys
from PyQt6.QtWidgets import QApplication

from .config import settings
from .utils import logger
from .ui import MainWindow


def main():
    """主函数"""
    # 初始化日志
    if settings.debug.log_to_file:
        logger.add_file_handler(settings.debug.log_file_path)
    
    logger.info(f"{'='*60}")
    logger.info(f"{settings.app_name} v{settings.version} 启动")
    logger.info(f"{'='*60}")
    
    # 创建应用
    app = QApplication(sys.argv)
    app.setApplicationName(settings.app_name)
    
    # 创建主窗口
    main_window = MainWindow()
    main_window.show()
    
    logger.info("应用程序已就绪")
    
    # 运行事件循环
    sys.exit(app.exec())


if __name__ == "__main__":
    main()
```

**检查**: ✅ 文件创建成功

---

### 步骤 5: 创建依赖文件 (2分钟)

**文件**: `requirements.txt`

**内容**:
```txt
pywin32>=305
PyQt6>=6.4.0
```

**检查**: ✅ 文件创建成功

---

### 步骤 6: 测试运行 (5分钟)

**命令**:
```bash
# 方式 1: 作为模块运行
cd C:\Users\user\EVE\EVE-window-capture
python -m src.main

# 方式 2: 直接运行
cd C:\Users\user\EVE\EVE-window-capture\src
python main.py
```

**预期结果**:
- ✅ 主窗口打开
- ✅ 可以选择窗口
- ✅ 可以打开区域选择器
- ✅ 可以启动监视

**检查**: ✅ 程序正常运行

---

## 🔧 故障排除

### 问题 1: 导入错误

**错误**: `ModuleNotFoundError: No module named 'src'`

**解决**: 
```bash
# 确保在正确的目录
cd C:\Users\user\EVE\EVE-window-capture

# 使用模块运行方式
python -m src.main
```

### 问题 2: 相对导入错误

**错误**: `ImportError: attempted relative import with no known parent package`

**解决**: 
- 确保所有 `__init__.py` 文件存在
- 使用 `-m` 参数运行模块

### 问题 3: 信号连接问题

**错误**: 程序运行但监视窗口没有显示图像

**解决**:
- 检查 `CaptureEngine` 的信号是否正确连接
- 检查 `engine.start()` 是否被调用
- 查看日志输出

---

## 📊 完成检查表

### 文件创建

- [ ] `src/ui/__init__.py`
- [ ] `src/ui/capture_window.py`
- [ ] `src/ui/main_window.py`
- [ ] `src/main.py`
- [ ] `requirements.txt`

### 功能测试

- [ ] 主窗口可以打开
- [ ] 可以枚举窗口列表
- [ ] 可以打开图形化区域选择器
- [ ] 可以拖拽选择区域
- [ ] 可以启动监视
- [ ] 监视窗口实时显示画面
- [ ] FPS 显示正常
- [ ] 可以暂停/继续
- [ ] 可以调节帧率

### 代码质量

- [ ] 无语法错误
- [ ] 无导入错误
- [ ] 日志输出正常
- [ ] 无警告信息

---

## 🎯 快速参考

### 导入路径对照

| 旧代码 | 新代码 |
|--------|--------|
| `debug_print()` | `from ..utils import logger` + `logger.debug()` |
| `settings` 变量 | `from ..config import settings` |
| `CaptureWindow(...)` | `from .capture_window import CaptureWindow` |
| `enum_windows()` | `from ..utils import WindowManager` + `WindowManager.enum_windows()` |
| `capture_window_screenshot()` | `from ..utils import ScreenCapture` + `ScreenCapture.capture_window()` |

### 关键变更

| 功能 | 旧实现 | 新实现 |
|------|--------|--------|
| 捕获逻辑 | 在 `CaptureWindow` 中 | 在 `CaptureEngine` 中 |
| 定时器 | 在 `CaptureWindow` 中 | 在 `CaptureEngine` 中 |
| 配置 | 硬编码 | `settings` 对象 |
| 日志 | `print()` | `logger.info/debug/error()` |
| 窗口管理 | 函数 | `WindowManager` 类 |
| 屏幕捕获 | 函数 | `ScreenCapture` 类 |

---

## 🚀 估计时间

- **步骤 1**: 5 分钟
- **步骤 2**: 30 分钟
- **步骤 3**: 30 分钟
- **步骤 4**: 10 分钟
- **步骤 5**: 2 分钟
- **步骤 6**: 5 分钟

**总计**: 约 **82 分钟** (1.5 小时)

---

## 💡 提示

1. **逐步测试**: 完成每个步骤后立即测试
2. **保留旧版本**: `window_capture_pyqt6.py` 作为参考
3. **查看日志**: 遇到问题先看日志输出
4. **参考文档**: 查看 `项目架构说明.md` 了解设计理念

---

## 🎉 完成后

恭喜！你现在拥有一个：
- ✅ 模块化的项目结构
- ✅ 符合 SOLID 原则的设计
- ✅ 易于测试和维护的代码
- ✅ 专业的软件工程实践

**下一步**: 可以考虑添加单元测试、CI/CD 等更高级的功能！

